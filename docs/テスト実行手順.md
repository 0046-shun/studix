# テスト実行手順

## Windows UNC環境での実行

### 前提条件
- Node.js がインストール済み
- PowerShell または CMD が利用可能

### 推奨実行手順

#### 1. pushd を使用した一時ドライブ割り当て

**PowerShell の場合:**
```powershell
# 一時ドライブ割り当て
pushd "\\dcfs01\23HS事業本部\HS事業本部_専用\大城\APP\studix\server"

# ローカルnpmキャッシュ設定
$env:NPM_CONFIG_CACHE = "C:\temp\npm-cache"

# テスト実行
npm test

# ドライブ割り当て解除
popd
```

**CMD の場合:**
```cmd
# 一時ドライブ割り当て
pushd "\\dcfs01\23HS事業本部\HS事業本部_専用\大城\APP\studix\server"

# ローカルnpmキャッシュ設定
set NPM_CONFIG_CACHE=C:\temp\npm-cache

# テスト実行
npm test

# ドライブ割り当て解除
popd
```

#### 2. 個別テストファイルの実行

**特定のテストファイルのみ実行:**
```bash
# 注文・要望APIテスト
npm test -- __tests__/orders_requests.test.js

# 商品・従業員・ユーザーAPIテスト
npm test -- __tests__/products_employees_users.test.js
```

**特定のテストケースのみ実行:**
```bash
# テスト名で絞り込み
npm test -- -t "POST /api/v1/orders/sheets"
```

#### 3. デバッグ用オプション

**詳細ログ出力:**
```bash
npm test -- --verbose --runInBand
```

**タイムアウト設定:**
```bash
npm test -- --testTimeout=30000
```

**ハンドル検出:**
```bash
npm test -- --detectOpenHandles --forceExit
```

**ログファイル出力:**
```bash
npm test -- --verbose > jest-result.txt 2>&1
```

### トラブルシューティング

#### npm install エラー
- **EPERM エラー**: 管理者権限で実行
- **UnauthorizedAccess**: PowerShell実行ポリシーを確認
- **UNC パス問題**: `pushd` で一時ドライブ割り当て

#### テストがRUNS状態で停滞
1. `--detectOpenHandles` で未終了ハンドルを特定
2. 個別テストケースで問題箇所を絞り込み
3. `--forceExit` で強制終了（最終手段）

#### 環境変数設定
```bash
# テスト環境設定
set NODE_ENV=test

# npm設定
set NPM_CONFIG_CACHE=C:\temp\npm-cache
set NPM_CONFIG_PREFIX=C:\temp\npm
```

### CI/CD 向け設定

#### GitHub Actions での実行
```yaml
- name: Run Tests
  run: |
    cd server
    npm ci
    npm test
  env:
    NODE_ENV: test
```

#### ローカルCI実行
```bash
# 依存関係インストール
npm ci

# テスト実行
npm test

# カバレッジ生成
npm run test:coverage
```

### 参考
- `docs/TASKS.md` - タスク一覧
- `server/package.json` - 依存関係とスクリプト
- `server/__tests__/` - テストファイル
