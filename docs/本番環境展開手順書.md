# 本番環境展開手順書

**作成日**: 2025-08-15  
**バージョン**: 1.0  
**対象**: システム管理者・DevOpsエンジニア

## 📋 概要

このドキュメントは、Studixシステムを本番環境に展開するための詳細な手順を記載しています。

### 🎯 展開目標
- セキュアでスケーラブルな本番環境の構築
- 24/7運用を支える監視・アラート体制の確立
- 災害復旧・バックアップ体制の構築
- セキュリティ要件の満足

## 🏗️ アーキテクチャ概要

```
[Internet] → [Load Balancer] → [Nginx (SSL終端)] → [Studix App] → [Redis]
                                    ↓
                              [Prometheus + Grafana]
```

### コンポーネント構成
- **Nginx**: リバースプロキシ、SSL終端、セキュリティヘッダー
- **Studix App**: Node.js APIサーバー（Docker化）
- **Redis**: セッション管理・キャッシュ
- **Prometheus**: メトリクス収集
- **Grafana**: 監視ダッシュボード

## 🔧 事前準備

### 1. 必要なツール
```bash
# Docker & Docker Compose
docker --version
docker-compose --version

# Git
git --version

# SSL証明書（Let's Encrypt推奨）
certbot --version
```

### 2. サーバー要件
- **CPU**: 2コア以上
- **メモリ**: 4GB以上
- **ストレージ**: 50GB以上（SSD推奨）
- **OS**: Ubuntu 20.04 LTS以上
- **ネットワーク**: 80/443ポート開放

### 3. ドメイン・SSL証明書
- 本番用ドメインの取得
- Let's Encrypt証明書の準備

## 🚀 展開手順

### Phase 1: 基盤構築

#### 1.1 サーバーセットアップ
```bash
# システムアップデート
sudo apt update && sudo apt upgrade -y

# 必要なパッケージのインストール
sudo apt install -y curl wget git htop nginx certbot python3-certbot-nginx

# Docker & Docker Compose インストール
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Docker Compose インストール
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### 1.2 プロジェクトクローン
```bash
# プロジェクトディレクトリ作成
sudo mkdir -p /opt/studix
sudo chown $USER:$USER /opt/studix
cd /opt/studix

# リポジトリクローン
git clone https://github.com/your-username/studix.git .
cd server
```

#### 1.3 環境変数設定
```bash
# 環境変数ファイル作成
cp .env.production.template .env.production

# 本番環境用の値を設定
nano .env.production
```

**必須環境変数**:
```bash
NODE_ENV=production
JWT_SECRET=your-super-secure-jwt-secret-key-here
SHEET_ID_ORDERS=your-orders-sheet-id
SHEET_ID_REQUESTS=your-requests-sheet-id
GOOGLE_CREDENTIALS_PATH=/app/credentials/google-credentials.json
CORS_ORIGIN=https://yourdomain.com
REDIS_PASSWORD=your-redis-password-here
```

#### 1.4 SSL証明書取得
```bash
# Nginx設定ファイルの準備
sudo cp nginx/nginx.conf /etc/nginx/nginx.conf
sudo mkdir -p /etc/nginx/ssl

# 一時的にHTTPで起動
sudo systemctl start nginx

# Let's Encrypt証明書取得
sudo certbot --nginx -d yourdomain.com

# 証明書の確認
sudo certbot certificates
```

### Phase 2: アプリケーション展開

#### 2.1 Dockerイメージビルド
```bash
# 本番用イメージビルド
docker build -f Dockerfile -t studix-server:production .

# イメージの確認
docker images | grep studix
```

#### 2.2 サービス起動
```bash
# 本番環境用Compose起動
docker-compose -f docker-compose.production.yml up -d

# サービス状態確認
docker-compose -f docker-compose.production.yml ps

# ログ確認
docker-compose -f docker-compose.production.yml logs -f app
```

#### 2.3 ヘルスチェック
```bash
# アプリケーションのヘルスチェック
curl -k https://yourdomain.com/health

# API エンドポイントの確認
curl -k https://yourdomain.com/api/v1/health
```

### Phase 3: 監視・運用体制構築

#### 3.1 Prometheus設定
```bash
# Prometheus設定ファイルの調整
nano monitoring/prometheus.yml

# サービス再起動
docker-compose -f docker-compose.production.yml restart prometheus
```

#### 3.2 Grafana設定
```bash
# Grafanaにアクセス
# URL: https://yourdomain.com:3001
# ユーザー: admin
# パスワード: .env.production で設定した値

# データソース追加
# Type: Prometheus
# URL: http://prometheus:9090

# ダッシュボードインポート
# 事前に準備したStudix用ダッシュボードをインポート
```

#### 3.3 アラート設定
```bash
# 重要なメトリクスの監視
# - レスポンスタイム > 2秒
# - エラー率 > 5%
# - メモリ使用率 > 80%
# - ディスク使用率 > 85%
```

### Phase 4: セキュリティ強化

#### 4.1 ファイアウォール設定
```bash
# UFW有効化
sudo ufw enable

# 必要なポートのみ開放
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 3000  # 必要に応じて

# ファイアウォール状態確認
sudo ufw status
```

#### 4.2 セキュリティスキャン
```bash
# 脆弱性スキャン実行
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image studix-server:production

# 依存関係の脆弱性チェック
npm audit --audit-level=high
```

#### 4.3 ログ監視設定
```bash
# ログローテーション設定
sudo nano /etc/logrotate.d/studix

# 例:
/var/log/studix/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 nodejs nodejs
    postrotate
        docker-compose -f /opt/studix/server/docker-compose.production.yml restart app
    endscript
}
```

## 📊 監視・アラート設定

### 重要なメトリクス
1. **アプリケーション**
   - レスポンスタイム
   - エラー率
   - リクエスト数
   - メモリ使用率

2. **インフラ**
   - CPU使用率
   - メモリ使用率
   - ディスク使用率
   - ネットワークI/O

3. **ビジネス**
   - 注文処理数
   - ユーザーアクティビティ
   - API使用量

### アラート閾値
```yaml
# 例: Grafana アラート設定
- name: High Error Rate
  condition: error_rate > 0.05  # 5%以上
  for: 5m
  
- name: High Response Time
  condition: response_time > 2000  # 2秒以上
  for: 3m
  
- name: High Memory Usage
  condition: memory_usage > 0.8   # 80%以上
  for: 5m
```

## 🔄 バックアップ・復旧

### バックアップ戦略
```bash
# 自動バックアップ実行
docker-compose -f docker-compose.production.yml exec backup /scripts/backup.js create

# バックアップ一覧確認
docker-compose -f docker-compose.production.yml exec backup /scripts/backup.js list

# 古いバックアップの削除
docker-compose -f docker-compose.production.yml exec backup /scripts/backup.js cleanup
```

### 復旧手順
1. **データ復旧**
   ```bash
   # バックアップから復旧
   docker-compose -f docker-compose.production.yml stop
   cp /var/backups/studix/YYYY-MM-DD-HHMMSS/* ./data/
   docker-compose -f docker-compose.production.yml up -d
   ```

2. **設定復旧**
   ```bash
   # 設定ファイルの復旧
   git checkout HEAD -- config.production.js
   # 環境変数の再設定
   ```

## 🚨 トラブルシューティング

### よくある問題と対処法

#### 1. アプリケーションが起動しない
```bash
# ログ確認
docker-compose -f docker-compose.production.yml logs app

# 環境変数確認
docker-compose -f docker-compose.production.yml exec app env | grep NODE_ENV

# 設定ファイル確認
docker-compose -f docker-compose.production.yml exec app cat config.js
```

#### 2. SSL証明書エラー
```bash
# 証明書の有効性確認
sudo certbot certificates

# 証明書の更新
sudo certbot renew

# Nginx設定の確認
sudo nginx -t
```

#### 3. メモリ不足
```bash
# メモリ使用量確認
free -h
docker stats

# 不要なコンテナ・イメージ削除
docker system prune -a
```

## 📈 パフォーマンスチューニング

### 1. Nginx設定最適化
```nginx
# nginx.conf の最適化
worker_processes auto;
worker_connections 1024;
keepalive_timeout 65;
gzip on;
gzip_comp_level 6;
```

### 2. Node.js最適化
```bash
# 環境変数で最適化
NODE_OPTIONS="--max-old-space-size=2048 --optimize-for-size"
```

### 3. Redis最適化
```bash
# Redis設定最適化
maxmemory 256mb
maxmemory-policy allkeys-lru
```

## 🔒 セキュリティチェックリスト

- [ ] ファイアウォール設定
- [ ] SSL証明書設定
- [ ] セキュリティヘッダー設定
- [ ] 環境変数の暗号化
- [ ] ログ監視設定
- [ ] バックアップ暗号化
- [ ] アクセス制御設定
- [ ] 脆弱性スキャン実行
- [ ] セキュリティアップデート設定

## 📞 サポート・連絡先

### 緊急時連絡先
- **システム管理者**: [連絡先情報]
- **DevOpsチーム**: [連絡先情報]
- **ベンダーサポート**: [連絡先情報]

### ドキュメント
- **システムアーキテクチャ**: `docs/システムアーキテクチャ設計書.md`
- **API仕様**: `docs/API設計書.md`
- **運用手順**: `docs/詳細設計書.md`

## 📝 更新履歴

| 日付 | バージョン | 更新内容 | 更新者 |
|------|------------|----------|--------|
| 2025-08-15 | 1.0 | 初版作成 | システム管理者 |

---

**注意**: このドキュメントは本番環境展開の標準手順です。実際の環境に合わせて適宜調整してください。
